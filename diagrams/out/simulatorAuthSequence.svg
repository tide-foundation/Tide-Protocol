<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="927px" preserveAspectRatio="none" style="width:429px;height:927px;" version="1.1" viewBox="0 0 429 927" width="429px" zoomAndPan="magnify"><defs><filter height="300%" id="fj7bv7ero0dwq" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="116" x="157" y="28.6855">Simulator Auth</text><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="752.1406" style="stroke: #383838; stroke-width: 1.0;" width="10" x="149.5" y="108.6016"/><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="576.6797" style="stroke: #383838; stroke-width: 1.0;" width="10" x="313.5" y="253.7109"/><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="255.1641" style="stroke: #000000; stroke-width: 2.0;" width="340" x="47" y="213.0078"/><rect fill="#FFFFFF" height="206.4609" style="stroke: none; stroke-width: 1.0;" width="340" x="47" y="261.7109"/><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="346.2188" style="stroke: #000000; stroke-width: 2.0;" width="404" x="13" y="522.5234"/><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="117.4063" style="stroke: #000000; stroke-width: 2.0;" width="177" x="230" y="620.9297"/><rect fill="#FFFFFF" height="42.3516" style="stroke: none; stroke-width: 1.0;" width="177" x="230" y="695.9844"/><rect fill="#FFFFFF" height="62.7031" style="stroke: none; stroke-width: 1.0;" width="404" x="13" y="806.0391"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="64" x2="64" y1="76.25" y2="885.7422"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="154" x2="154" y1="76.25" y2="885.7422"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="318" x2="318" y1="76.25" y2="885.7422"/><rect fill="#F8F8F8" filter="url(#fj7bv7ero0dwq)" height="31.6094" style="stroke: #383838; stroke-width: 1.5;" width="79" x="23" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="65" x="30" y="61.1738">Consumer</text><rect fill="#F8F8F8" filter="url(#fj7bv7ero0dwq)" height="31.6094" style="stroke: #383838; stroke-width: 1.5;" width="79" x="23" y="884.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="65" x="30" y="906.2754">Consumer</text><rect fill="#F8F8F8" filter="url(#fj7bv7ero0dwq)" height="31.6094" style="stroke: #383838; stroke-width: 1.5;" width="37" x="134" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="23" x="141" y="61.1738">Ork</text><rect fill="#F8F8F8" filter="url(#fj7bv7ero0dwq)" height="31.6094" style="stroke: #383838; stroke-width: 1.5;" width="37" x="134" y="884.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="23" x="141" y="906.2754">Ork</text><rect fill="#F8F8F8" filter="url(#fj7bv7ero0dwq)" height="31.6094" style="stroke: #383838; stroke-width: 1.5;" width="73" x="280" y="39.6406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="287" y="61.1738">Simulator</text><rect fill="#F8F8F8" filter="url(#fj7bv7ero0dwq)" height="31.6094" style="stroke: #383838; stroke-width: 1.5;" width="73" x="280" y="884.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="287" y="906.2754">Simulator</text><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="752.1406" style="stroke: #383838; stroke-width: 1.0;" width="10" x="149.5" y="108.6016"/><rect fill="#FFFFFF" filter="url(#fj7bv7ero0dwq)" height="576.6797" style="stroke: #383838; stroke-width: 1.0;" width="10" x="313.5" y="253.7109"/><polygon fill="#383838" points="137.5,104.6016,147.5,108.6016,137.5,112.6016,141.5,108.6016" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="64.5" x2="143.5" y1="108.6016" y2="108.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="71.5" y="103.7451">tideAction()</text><path d="M79,121.6016 L79,196.6016 L225,196.6016 L225,131.6016 L215,121.6016 L79,121.6016 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M215,121.6016 L215,131.6016 L225,131.6016 L215,121.6016 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="85" y="140.0967">tx = new Transaction(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="85" y="156.4482">location,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="85" y="172.7998">payload,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="85" y="189.1514">sign(payload,orkSk))</text><path d="M47,213.0078 L108,213.0078 L108,221.0078 L98,231.0078 L47,231.0078 L47,213.0078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="255.1641" style="stroke: #000000; stroke-width: 2.0;" width="340" x="47" y="213.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="62" y="227.5029">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="123" y="226.4268">[isAuthenticated ?]</text><polygon fill="#383838" points="301.5,249.7109,311.5,253.7109,301.5,257.7109,305.5,253.7109" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="159.5" x2="307.5" y1="253.7109" y2="253.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="166.5" y="248.8545">Post(tx)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="47" x2="387" y1="262.7109" y2="262.7109"/><path d="M57,268.7109 L57,327.7109 L248,327.7109 L248,278.7109 L238,268.7109 L57,268.7109 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M238,268.7109 L238,278.7109 L248,278.7109 L238,268.7109 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="63" y="287.2061">authReq = new AuthRequest(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="63" y="303.5576">orkId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="63" y="319.9092">orkPk)</text><polygon fill="#383838" points="301.5,355.1172,311.5,359.1172,301.5,363.1172,305.5,359.1172" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="159.5" x2="307.5" y1="359.1172" y2="359.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="166.5" y="354.2607">register/login(authReq)</text><path d="M260,372.1172 L260,398.1172 L373,398.1172 L373,382.1172 L363,372.1172 L260,372.1172 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M363,372.1172 L363,382.1172 L373,382.1172 L363,372.1172 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="266" y="390.6123">createAccount()</text><polygon fill="#383838" points="170.5,425.8203,160.5,429.8203,170.5,433.8203,166.5,429.8203" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="164.5" x2="312.5" y1="429.8203" y2="429.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="176.5" y="424.9639">ok()</text><polygon fill="#383838" points="301.5,456.1719,311.5,460.1719,301.5,464.1719,305.5,460.1719" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="159.5" x2="307.5" y1="460.1719" y2="460.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="166.5" y="455.3154">Post(tx)</text><path d="M246,480.1719 L246,506.1719 L387,506.1719 L387,490.1719 L377,480.1719 L246,480.1719 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M377,480.1719 L377,490.1719 L387,490.1719 L377,480.1719 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="252" y="498.667">verify(payload,orkPk)</text><path d="M13,522.5234 L74,522.5234 L74,530.5234 L64,540.5234 L13,540.5234 L13,522.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="346.2188" style="stroke: #000000; stroke-width: 2.0;" width="404" x="13" y="522.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="28" y="537.0186">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="55" x="89" y="535.9424">[isValid ?]</text><path d="M243,545.875 L243,604.875 L390,604.875 L390,555.875 L380,545.875 L243,545.875 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M380,545.875 L380,555.875 L390,555.875 L380,545.875 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="249" y="564.3701">curTx = getCurrentTx(</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="249" y="580.7217">location,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="249" y="597.0732">index)</text><path d="M230,620.9297 L291,620.9297 L291,628.9297 L281,638.9297 L230,638.9297 L230,620.9297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="117.4063" style="stroke: #000000; stroke-width: 2.0;" width="177" x="230" y="620.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="245" y="635.4248">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="306" y="634.3486">[curTx != null ?]</text><path d="M240,644.2813 L240,686.2813 L393,686.2813 L393,654.2813 L383,644.2813 L240,644.2813 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M383,644.2813 L383,654.2813 L393,654.2813 L383,644.2813 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="246" y="662.7764">curTx.isStale = true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="246" y="679.1279">batchCommit(tx,curTx)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="230" x2="407" y1="696.9844" y2="696.9844"/><path d="M275,702.9844 L275,728.9844 L358,728.9844 L358,712.9844 L348,702.9844 L275,702.9844 " fill="#ECECEC" filter="url(#fj7bv7ero0dwq)" style="stroke: #383838; stroke-width: 1.0;"/><path d="M348,702.9844 L348,712.9844 L358,712.9844 L348,702.9844 " fill="#ECECEC" style="stroke: #383838; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="281" y="721.4795">commit(tx)</text><polygon fill="#383838" points="170.5,763.6875,160.5,767.6875,170.5,771.6875,166.5,767.6875" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="164.5" x2="312.5" y1="767.6875" y2="767.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="176.5" y="762.8311">ok(txId)</text><polygon fill="#383838" points="75.5,794.0391,65.5,798.0391,75.5,802.0391,71.5,798.0391" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="69.5" x2="148.5" y1="798.0391" y2="798.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="81.5" y="793.1826">ok()</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="13" x2="417" y1="807.0391" y2="807.0391"/><polygon fill="#383838" points="170.5,826.3906,160.5,830.3906,170.5,834.3906,166.5,830.3906" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="164.5" x2="317.5" y1="830.3906" y2="830.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="176.5" y="825.5342">unarthorized()</text><polygon fill="#383838" points="75.5,856.7422,65.5,860.7422,75.5,864.7422,71.5,860.7422" style="stroke: #383838; stroke-width: 1.0;"/><line style="stroke: #383838; stroke-width: 1.0;" x1="69.5" x2="153.5" y1="860.7422" y2="860.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="81.5" y="855.8857">error()</text><!--MD5=[552dedae8d119daae33cc5194bdc67de]
@startuml simulatorAuthSequence
skinparam monochrome true

title Simulator Auth

Consumer->Ork: tideAction()
 activate Ork
note over Ork
    tx = new Transaction(
    location,
    payload,
    sign(payload,orkSk))
end note
alt isAuthenticated ?
    Ork->Simulator:Post(tx)
    activate Simulator
else
note over Ork
    authReq = new AuthRequest(
    orkId,
    orkPk)
end note
    Ork- ->Simulator: register/login(authReq)
    note over Simulator: createAccount()
    Simulator->Ork:ok()
    Ork->Simulator:Post(tx)
end
note over Simulator:verify(payload,orkPk)
alt isValid ?
        note over Simulator
        curTx = getCurrentTx(
        location, 
        index)
        end note
    alt curTx != null ?
        note over Simulator
        curTx.isStale = true
        batchCommit(tx,curTx)
        end note
    else
        note over Simulator: commit(tx)
end
Simulator->Ork:ok(txId)
Ork->Consumer:ok()
else

    Simulator->Ork:unarthorized()
    deactivate Simulator
    Ork->Consumer:error()
deactivate Ork
end


' OLD TOKEN FLOW
' Ork->Simulator: Login(user,pass)
' activate Simulator
' Simulator->Simulator:Check for user
' alt exists && valid ?
'     Simulator- ->Ork: GenerateToken()
' else
'     Simulator- ->Ork: Unauthorized
' end
' Ork->Ork:Store token
' Ork->Simulator: Request
' note over Simulator,Ork: Header:Authorization token
' alt validToken && validScope ?
'     Simulator- ->Ork: Handle Transaction
' else
'     Simulator- ->Ork: Unauthorized
' end
' deactivate Simulator

@enduml

@startuml simulatorAuthSequence
skinparam monochrome true

title Simulator Auth

Consumer->Ork: tideAction()
 activate Ork
note over Ork
    tx = new Transaction(
    location,
    payload,
    sign(payload,orkSk))
end note
alt isAuthenticated ?
    Ork->Simulator:Post(tx)
    activate Simulator
else
note over Ork
    authReq = new AuthRequest(
    orkId,
    orkPk)
end note
    Ork- ->Simulator: register/login(authReq)
    note over Simulator: createAccount()
    Simulator->Ork:ok()
    Ork->Simulator:Post(tx)
end
note over Simulator:verify(payload,orkPk)
alt isValid ?
        note over Simulator
        curTx = getCurrentTx(
        location, 
        index)
        end note
    alt curTx != null ?
        note over Simulator
        curTx.isStale = true
        batchCommit(tx,curTx)
        end note
    else
        note over Simulator: commit(tx)
end
Simulator->Ork:ok(txId)
Ork->Consumer:ok()
else

    Simulator->Ork:unarthorized()
    deactivate Simulator
    Ork->Consumer:error()
deactivate Ork
end



@enduml

PlantUML version 1.2020.10(Sun May 17 19:35:57 AEST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 15+36
Operating System: Windows 10
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>